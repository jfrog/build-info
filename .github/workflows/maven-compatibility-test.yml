name: Maven Compatibility Test

# This workflow proactively tests build-info-extractor-maven3 compatibility with multiple Maven versions
# to catch breaking changes early (e.g., new required fields in DefaultMavenPluginManager).
#
# When a compatibility issue is detected:
# 1. Check error logs for NullPointerException, NoSuchMethodError, etc.
# 2. Compare Maven's DefaultMavenPluginManager with our components.xml
# 3. Add missing field declarations to components.xml
# 4. See CHECK-MAVEN-FIELDS.sh for a helper script to identify missing fields

on:
  # Run on PRs for testing (remove after initial validation)
  pull_request:
    branches: [ master, main ]
  
  # Run nightly to catch new Maven releases
  schedule:
    - cron: '0 2 * * *'  # Every night at 2 AM UTC
  
  # Allow manual trigger for testing
  workflow_dispatch:

jobs:
  check-latest-maven-versions:
    name: Check for new Maven versions
    runs-on: ubuntu-latest
    
    steps:
      - name: Get latest Maven versions from Maven Central
        id: maven-versions
        run: |
          echo "Fetching latest Maven versions from Maven Central..."
          
          # Fetch Maven metadata
          curl -s https://repo.maven.apache.org/maven2/org/apache/maven/maven-core/maven-metadata.xml > maven-metadata.xml
          
          # Extract all versions
          VERSIONS=$(grep -oP '(?<=<version>)[^<]+' maven-metadata.xml | grep -E '^[0-9]+\.[0-9]+\.[0-9]+' | sort -V)
          
          echo "Available Maven versions:"
          echo "$VERSIONS"
          
          # Get latest versions for each major.minor
          LATEST_3_8=$(echo "$VERSIONS" | grep '^3\.8\.' | tail -1)
          LATEST_3_9=$(echo "$VERSIONS" | grep '^3\.9\.' | tail -1)
          LATEST_4_0=$(echo "$VERSIONS" | grep '^4\.0\.' | tail -1)
          
          echo ""
          echo "Latest versions by series:"
          echo "  3.8.x: $LATEST_3_8"
          echo "  3.9.x: $LATEST_3_9"
          echo "  4.0.x: $LATEST_4_0"
          
          # Check if we need to update the workflow
          echo ""
          echo "Current versions in workflow: 3.8.8, 3.9.0, 3.9.6, 3.9.9, 3.9.11, 3.9.12, 4.0.0-beta-4"
          echo ""
          
          if [ "$LATEST_3_9" != "3.9.12" ]; then
            echo "‚ö†Ô∏è  WARNING: New Maven 3.9.x version available: $LATEST_3_9"
            echo "Consider updating the workflow matrix to include this version"
          fi
          
          if [ -n "$LATEST_4_0" ]; then
            echo "‚ÑπÔ∏è  Maven 4.0 stable version found: $LATEST_4_0"
            echo "Consider testing with this version"
          fi

  test-maven-compatibility:
    name: Test with Maven ${{ matrix.maven-version }}
    runs-on: ubuntu-latest
    needs: check-latest-maven-versions
    
    strategy:
      fail-fast: false  # Test all versions even if one fails
      matrix:
        maven-version:
          - '3.8.8'   # Stable older version
          - '3.9.0'   # First 3.9.x release
          - '3.9.6'   # Mid 3.9.x
          - '3.9.9'   # Later 3.9.x
          - '3.9.11'  # Recent 3.9.x
          - '3.9.12'  # Latest 3.9.x (update periodically)
          - '4.0.0-beta-4'  # Maven 4 pre-release (update when stable releases)
        java-version:
          - '8'
          - '11'
          - '17'
          - '21'
        exclude:
          # Maven 4 requires Java 17+
          - maven-version: '4.0.0-beta-4'
            java-version: '8'
          - maven-version: '4.0.0-beta-4'
            java-version: '11'

    steps:
      - name: Checkout build-info
        uses: actions/checkout@v4

      - name: Set up JDK 8 for building
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Verify build environment
        run: |
          echo "Java version for building:"
          java -version
          echo ""
          echo "Gradle version:"
          ./gradlew --version
          echo ""
          echo "Project structure:"
          ls -la build-info-extractor-maven3/

      - name: Build build-info-extractor
        run: |
          # Ensure Gradle wrapper is executable
          chmod +x gradlew
          
          # Clean and build ALL artifacts including uber JAR
          # The 'build' task creates both regular and uber JARs
          ./gradlew clean :build-info-extractor-maven3:build -x test --no-build-cache --info
          
          echo ""
          echo "Build output directory:"
          ls -lh build-info-extractor-maven3/build/libs/ || {
            echo "‚ùå ERROR: Build directory doesn't exist!"
            echo "Build failed completely"
            exit 1
          }
          
          # Verify uber JAR was created
          if ! ls build-info-extractor-maven3/build/libs/*-uber.jar 1> /dev/null 2>&1; then
            echo ""
            echo "‚ùå ERROR: Uber JAR was not built!"
            echo "Build may have failed or task was skipped"
            echo ""
            echo "Available files in build/libs:"
            ls -la build-info-extractor-maven3/build/libs/
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Uber JAR successfully built"

      - name: Set up test JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java-version }}

      - name: Set up Maven ${{ matrix.maven-version }}
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: ${{ matrix.maven-version }}

      - name: Verify Maven version
        run: |
          mvn --version
          echo "M2_HOME=$M2_HOME"

      - name: Set up JFrog CLI
        uses: jfrog/setup-jfrog-cli@v4
        with:
          version: latest
        # Note: No server credentials needed - we're testing extractor loading, not Artifactory integration

      - name: Install built extractor JAR
        run: |
          # Get the actual version from build output
          BUILT_JAR=$(find build-info-extractor-maven3/build/libs/ -name "*-uber.jar" -type f | head -1)
          
          if [ -z "$BUILT_JAR" ]; then
            echo "‚ùå No uber JAR found!"
            echo "Available files:"
            ls -la build-info-extractor-maven3/build/libs/ || echo "Directory doesn't exist"
            exit 1
          fi
          
          echo "Found JAR: $BUILT_JAR"
          
          # Extract version from JAR filename
          # e.g., build-info-extractor-maven3-2.43.x-SNAPSHOT-uber.jar -> 2.43.x-SNAPSHOT
          JAR_NAME=$(basename "$BUILT_JAR")
          VERSION=$(echo "$JAR_NAME" | sed -E 's/build-info-extractor-maven3-(.+)-uber\.jar/\1/')
          
          if [ -z "$VERSION" ]; then
            echo "‚ö†Ô∏è  Could not extract version from JAR name"
            VERSION="2.43.x-SNAPSHOT"
          fi
          
          echo "Extractor version: $VERSION"
          
          # Create cache directory structure
          mkdir -p ~/.jfrog/dependencies/maven/$VERSION
          
          # Copy with correct name
          cp "$BUILT_JAR" ~/.jfrog/dependencies/maven/$VERSION/build-info-extractor-maven3-$VERSION-uber.jar
          
          echo "Installed JAR:"
          ls -lh ~/.jfrog/dependencies/maven/$VERSION/
          
          echo ""
          echo "‚úÖ Build-info extractor installed and ready for testing"

      - name: Create test Maven project
        run: |
          # Create project structure
          mkdir -p ${{ github.workspace }}/test-project/src/main/java/com/test
          cd ${{ github.workspace }}/test-project
          
          cat > pom.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
                   http://maven.apache.org/xsd/maven-4.0.0.xsd">
              <modelVersion>4.0.0</modelVersion>
              
              <groupId>com.jfrog.test</groupId>
              <artifactId>maven-compatibility-test</artifactId>
              <version>1.0.0-SNAPSHOT</version>
              <packaging>jar</packaging>
              
              <properties>
                  <maven.compiler.source>8</maven.compiler.source>
                  <maven.compiler.target>8</maven.compiler.target>
                  <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
              </properties>
              
              <dependencies>
                  <dependency>
                      <groupId>org.apache.commons</groupId>
                      <artifactId>commons-lang3</artifactId>
                      <version>3.14.0</version>
                  </dependency>
              </dependencies>
          </project>
          EOF
          
          cat > src/main/java/com/test/App.java << 'EOF'
          package com.test;
          
          import org.apache.commons.lang3.StringUtils;
          
          public class App {
              public static void main(String[] args) {
                  System.out.println("Maven version test: " + 
                      StringUtils.capitalize("success"));
              }
          }
          EOF
          
          # Verify project was created
          echo ""
          echo "Test project structure:"
          ls -la ${{ github.workspace }}/test-project/
          echo ""
          echo "‚úÖ Test project created successfully"

      - name: Configure JFrog Maven (minimal config for testing)
        working-directory: ${{ github.workspace }}/test-project
        run: |
          # Create a minimal JFrog CLI server config
          mkdir -p ~/.jfrog/security
          
          # Create server config file directly (bypass validation)
          cat > ~/.jfrog/security/config.yaml << 'EOF'
          version: 5
          servers:
            - serverId: "local"
              url: "http://localhost:8081/artifactory/"
              artifactoryUrl: "http://localhost:8081/artifactory/"
              user: "test"
              password: "test"
              isDefault: true
          EOF
          
          # Create Maven project config
          mkdir -p ~/.jfrog/projects
          cat > ~/.jfrog/projects/maven.yaml << 'EOF'
          version: 1
          type: maven
          resolver:
            repo: libs-release
            serverId: local
          deployer:
            repo: libs-release-local
            serverId: local
          EOF
          
          echo "‚úÖ Maven config created (for extractor testing only)"
          echo "Server config:"
          cat ~/.jfrog/security/config.yaml
          echo ""
          echo "Maven config:"
          cat ~/.jfrog/projects/maven.yaml

      - name: Test Maven with build-info extractor
        id: maven_test
        continue-on-error: true
        working-directory: ${{ github.workspace }}/test-project
        run: |
          echo "Testing Maven ${{ matrix.maven-version }} with build-info extractor"
          echo ""
          
          # Run jf mvn to load the build-info extractor
          # The extractor will be loaded, and if there are compatibility issues
          # (like missing fields in components.xml), they will appear immediately
          # 
          # The build will fail early if there are Maven version incompatibilities,
          # even without Artifactory connectivity
          jf mvn clean compile 2>&1 | tee maven-output.log || true
          
          # Save exit code
          echo "MAVEN_EXIT_CODE=$?" >> $GITHUB_ENV

      - name: Check for compatibility errors
        if: always()
        working-directory: ${{ github.workspace }}/test-project
        run: |
          # Check if the test actually ran
          if [ ! -f maven-output.log ]; then
            echo "‚ùå ERROR: No output log found!"
            echo "This usually means configuration or test setup failed."
            echo "Check previous steps for errors."
            exit 1
          fi
          
          echo "Analyzing Maven output..."
          echo ""
          
          # Check for success indicators
          if grep -q "BUILD SUCCESS" maven-output.log; then
            echo "‚úÖ Maven build completed successfully"
            echo "Maven ${{ matrix.maven-version }} with Java ${{ matrix.java-version }} - COMPATIBLE"
            exit 0
          fi
          
          # Build failed - analyze why
          echo "‚ö†Ô∏è  Maven build failed - analyzing error..."
          echo ""
          
          # Check for various compatibility issues
          if grep -q "NullPointerException.*is null" maven-output.log; then
            echo "‚ùå FAILURE: NullPointerException detected!"
            echo "Maven ${{ matrix.maven-version }} has compatibility issues!"
            echo ""
            echo "This could indicate missing field declarations in components.xml"
            echo ""
            echo "Error details:"
            grep -B3 -A5 "NullPointerException" maven-output.log | head -20
            
            # Fail the workflow
            exit 1
          elif grep -q "NoSuchMethodError\|NoClassDefFoundError\|IncompatibleClassChangeError" maven-output.log; then
            echo "‚ùå FAILURE: Class compatibility error detected!"
            echo "Maven ${{ matrix.maven-version }} has breaking changes!"
            echo ""
            grep -B3 -A5 "Error" maven-output.log | head -20
            exit 1
          elif grep -q "Could not transfer artifact\|Connection refused\|UnknownHostException\|Server ID.*URL is required\|Could not find a server with ID" maven-output.log; then
            echo "‚ö†Ô∏è  Network/configuration issue - not a compatibility problem"
            echo "This is expected when running without a real Artifactory instance"
            echo ""
            echo "Checking if extractor loaded successfully..."
            if grep -q "Running Mvn\|Running mvn command\|Downloading JFrog's Dependency\|maven build config successfully created" maven-output.log; then
              echo "‚úÖ Build-info extractor was invoked - no Maven compatibility issues detected"
              echo "Maven ${{ matrix.maven-version }} with Java ${{ matrix.java-version }} - COMPATIBLE"
              exit 0
            else
              echo "‚ö†Ô∏è  Could not confirm extractor loaded, but no compatibility errors detected"
              echo "Maven ${{ matrix.maven-version }} with Java ${{ matrix.java-version }} - Assumed COMPATIBLE"
              exit 0
            fi
          elif grep -q "no config file was found" maven-output.log; then
            echo "‚ö†Ô∏è  JFrog config issue - checking if extractor loaded despite warning"
            if grep -q "Running Mvn\|Running mvn command" maven-output.log; then
              echo "‚úÖ Extractor loaded successfully"
              exit 0
            elif grep -q "NullPointerException\|NoSuchMethodError\|NoClassDefFoundError" maven-output.log; then
              echo "‚ùå Found compatibility errors"
              tail -30 maven-output.log
              exit 1
            else
              echo "‚úÖ No compatibility issues found"
              exit 0
            fi
          else
            echo "‚ùå Build failed for unknown compatibility reasons"
            echo "Last 50 lines of output:"
            tail -50 maven-output.log
            # Fail to be safe - investigate unknown failures
            exit 1
          fi

      - name: Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs-maven-${{ matrix.maven-version }}-java-${{ matrix.java-version }}
          path: ${{ github.workspace }}/test-project/maven-output.log
          retention-days: 30
          if-no-files-found: ignore

  create-issue-on-failure:
    name: Create issue if compatibility test fails
    needs: [test-maven-compatibility]
    # Only run on main branch or non-fork PRs (to avoid permission errors on fork PRs)
    if: failure() && (github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository)
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: Create issue
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const title = 'üö® Maven Compatibility Test Failed';
            const body = `## Maven Compatibility Test Failure
            
            The automated Maven compatibility test has detected a failure with one or more Maven versions.
            
            **Details:**
            - Run: ${{ github.run_number }}
            - Workflow: ${{ github.workflow }}
            - Triggered by: ${{ github.event_name }}
            - Link: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            **Possible Causes:**
            1. A new Maven version has been released with breaking changes
            2. New required fields have been added to DefaultMavenPluginManager
            3. Method signatures have changed in Maven core classes
            4. New dependencies or requirements were introduced
            5. Our Plexus components.xml is missing field declarations
            
            **Action Required:**
            1. Check the "Check for new Maven versions" job output to see if new versions were detected
            2. Check the workflow logs for specific error messages
            3. Download the failure logs artifact from the workflow run
            4. Look for error patterns:
               - \`NullPointerException\` ‚Üí Missing field in components.xml
               - \`NoSuchMethodError\` ‚Üí Method signature changed
               - \`NoClassDefFoundError\` ‚Üí Missing dependency
            5. If NullPointerException on a field:
               - Identify the missing field name from the error
               - Download Maven source for that version
               - Use \`CHECK-MAVEN-FIELDS.sh <maven-version>\` to compare fields
               - Update \`build-info-extractor-maven3/src/main/resources/META-INF/plexus/components.xml\`
               - Add missing field requirements to the ArtifactoryEclipsePluginManager component
            6. If a new Maven version was detected, update the workflow matrix to include it
            
            **Helpful Commands:**
            \`\`\`bash
            # Check for missing fields in a specific Maven version
            ./CHECK-MAVEN-FIELDS.sh <maven-version>
            
            # Compare Maven's DefaultMavenPluginManager with our components.xml
            # Look for new fields that need to be added
            \`\`\`
            
            **Resources:**
            - Maven release notes: https://maven.apache.org/docs/history.html
            - Our components.xml: \`build-info-extractor-maven3/src/main/resources/META-INF/plexus/components.xml\`
            - DefaultMavenPluginManager source: Search in Maven's GitHub repository
            `;
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'maven-compatibility'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'maven-compatibility', 'automated']
              });
            } else {
              console.log('Issue already exists, adding comment instead');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `Another failure detected in run #${{ github.run_number }}\n\nLink: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
              });
            }
