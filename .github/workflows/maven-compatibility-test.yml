name: Maven Compatibility Test

on:
  # Run on PRs and pushes to main branches
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  
  # Run weekly to catch new Maven releases
  schedule:
    - cron: '0 0 * * 1'  # Every Monday at midnight UTC
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  test-maven-compatibility:
    name: Test with Maven ${{ matrix.maven-version }}
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false  # Test all versions even if one fails
      matrix:
        maven-version:
          - '3.8.8'   # Stable older version
          - '3.9.0'   # First 3.9.x release
          - '3.9.6'   # Mid 3.9.x
          - '3.9.9'   # Later 3.9.x
          - '3.9.11'  # Recent 3.9.x
          - '3.9.12'  # Latest 3.9.x
          - '4.0.0-beta-4'  # Maven 4 pre-release
        java-version:
          - '8'
          - '11'
          - '17'
          - '21'
        exclude:
          # Maven 4 requires Java 17+
          - maven-version: '4.0.0-beta-4'
            java-version: '8'
          - maven-version: '4.0.0-beta-4'
            java-version: '11'

    steps:
      - name: Checkout build-info
        uses: actions/checkout@v4

      - name: Set up JDK 8 for building
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '8'

      - name: Verify build environment
        run: |
          echo "Java version for building:"
          java -version
          echo ""
          echo "Gradle version:"
          ./gradlew --version
          echo ""
          echo "Project structure:"
          ls -la build-info-extractor-maven3/

      - name: Build build-info-extractor
        run: |
          # Ensure Gradle wrapper is executable
          chmod +x gradlew
          
          # Clean and build ALL artifacts including uber JAR
          # The 'build' task creates both regular and uber JARs
          ./gradlew clean :build-info-extractor-maven3:build -x test --no-build-cache --info
          
          echo ""
          echo "Build output directory:"
          ls -lh build-info-extractor-maven3/build/libs/ || {
            echo "‚ùå ERROR: Build directory doesn't exist!"
            echo "Build failed completely"
            exit 1
          }
          
          # Verify uber JAR was created
          if ! ls build-info-extractor-maven3/build/libs/*-uber.jar 1> /dev/null 2>&1; then
            echo ""
            echo "‚ùå ERROR: Uber JAR was not built!"
            echo "Build may have failed or task was skipped"
            echo ""
            echo "Available files in build/libs:"
            ls -la build-info-extractor-maven3/build/libs/
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Uber JAR successfully built"

      - name: Set up test JDK ${{ matrix.java-version }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java-version }}

      - name: Set up Maven ${{ matrix.maven-version }}
        uses: stCarolas/setup-maven@v5
        with:
          maven-version: ${{ matrix.maven-version }}

      - name: Verify Maven version
        run: |
          mvn --version
          echo "M2_HOME=$M2_HOME"

      - name: Install built extractor JAR
        run: |
          # Get the actual version from build output
          BUILT_JAR=$(find build-info-extractor-maven3/build/libs/ -name "*-uber.jar" -type f | head -1)
          
          if [ -z "$BUILT_JAR" ]; then
            echo "‚ùå No uber JAR found!"
            echo "Available files:"
            ls -la build-info-extractor-maven3/build/libs/ || echo "Directory doesn't exist"
            exit 1
          fi
          
          echo "Found JAR: $BUILT_JAR"
          
          # Extract version from JAR filename
          # e.g., build-info-extractor-maven3-2.43.x-SNAPSHOT-uber.jar -> 2.43.x-SNAPSHOT
          JAR_NAME=$(basename "$BUILT_JAR")
          VERSION=$(echo "$JAR_NAME" | sed -E 's/build-info-extractor-maven3-(.+)-uber\.jar/\1/')
          
          if [ -z "$VERSION" ]; then
            echo "‚ö†Ô∏è  Could not extract version from JAR name"
            VERSION="2.43.x-SNAPSHOT"
          fi
          
          echo "Extractor version: $VERSION"
          
          # Create cache directory structure
          mkdir -p ~/.jfrog/dependencies/maven/$VERSION
          
          # Copy with correct name
          cp "$BUILT_JAR" ~/.jfrog/dependencies/maven/$VERSION/build-info-extractor-maven3-$VERSION-uber.jar
          
          echo "Installed JAR:"
          ls -lh ~/.jfrog/dependencies/maven/$VERSION/
          
          echo ""
          echo "‚úÖ Build-info extractor installed and ready for testing"

      - name: Create test Maven project
        run: |
          # Create project structure
          mkdir -p ${{ github.workspace }}/test-project/src/main/java/com/test
          cd ${{ github.workspace }}/test-project
          
          cat > pom.xml << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <project xmlns="http://maven.apache.org/POM/4.0.0"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
                   http://maven.apache.org/xsd/maven-4.0.0.xsd">
              <modelVersion>4.0.0</modelVersion>
              
              <groupId>com.jfrog.test</groupId>
              <artifactId>maven-compatibility-test</artifactId>
              <version>1.0.0-SNAPSHOT</version>
              <packaging>jar</packaging>
              
              <properties>
                  <maven.compiler.source>8</maven.compiler.source>
                  <maven.compiler.target>8</maven.compiler.target>
                  <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
              </properties>
              
              <dependencies>
                  <dependency>
                      <groupId>org.apache.commons</groupId>
                      <artifactId>commons-lang3</artifactId>
                      <version>3.14.0</version>
                  </dependency>
              </dependencies>
          </project>
          EOF
          
          cat > src/main/java/com/test/App.java << 'EOF'
          package com.test;
          
          import org.apache.commons.lang3.StringUtils;
          
          public class App {
              public static void main(String[] args) {
                  System.out.println("Maven version test: " + 
                      StringUtils.capitalize("success"));
              }
          }
          EOF
          
          # Verify project was created
          echo ""
          echo "Test project structure:"
          ls -la ${{ github.workspace }}/test-project/
          echo ""
          echo "‚úÖ Test project created successfully"

      - name: Test Maven with build-info extractor
        id: maven_test
        continue-on-error: true
        working-directory: ${{ github.workspace }}/test-project
        run: |
          # Get extractor version
          BUILT_JAR=$(find ~/.jfrog/dependencies/maven/ -name "*-uber.jar" -type f | head -1)
          EXTRACTOR_DIR=$(dirname "$BUILT_JAR")
          
          echo "Testing Maven ${{ matrix.maven-version }} with build-info extractor"
          echo "Extractor directory: $EXTRACTOR_DIR"
          echo ""
          
          # Run Maven with build-info extractor loaded
          # This simulates what jf mvn does - loads the extractor as a Maven extension
          mvn clean compile \
            -Dmaven.ext.class.path="$BUILT_JAR" \
            -Dm3plugin.lib="$EXTRACTOR_DIR" 2>&1 | tee maven-output.log
          
          # Save exit code
          echo "MAVEN_EXIT_CODE=${PIPESTATUS[0]}" >> $GITHUB_ENV

      - name: Check for compatibility errors
        if: always()
        working-directory: ${{ github.workspace }}/test-project
        run: |
          # Check if the test actually ran
          if [ ! -f maven-output.log ]; then
            echo "‚ùå ERROR: No output log found!"
            echo "This usually means configuration or test setup failed."
            echo "Check previous steps for errors."
            exit 1
          fi
          
          echo "Analyzing Maven output..."
          echo ""
          
          # Check for success indicators
          if grep -q "BUILD SUCCESS" maven-output.log; then
            echo "‚úÖ Maven build completed successfully"
            echo "Maven ${{ matrix.maven-version }} with Java ${{ matrix.java-version }} - COMPATIBLE"
            exit 0
          fi
          
          # Build failed - analyze why
          echo "‚ö†Ô∏è  Maven build failed - analyzing error..."
          echo ""
          
          # Check for various compatibility issues
          if grep -q "NullPointerException.*is null" maven-output.log; then
            echo "‚ùå FAILURE: NullPointerException detected!"
            echo "Maven ${{ matrix.maven-version }} has compatibility issues!"
            echo ""
            echo "This could indicate missing field declarations in components.xml"
            echo ""
            echo "Error details:"
            grep -B3 -A5 "NullPointerException" maven-output.log | head -20
            
            # Fail the workflow
            exit 1
          elif grep -q "NoSuchMethodError\|NoClassDefFoundError\|IncompatibleClassChangeError" maven-output.log; then
            echo "‚ùå FAILURE: Class compatibility error detected!"
            echo "Maven ${{ matrix.maven-version }} has breaking changes!"
            echo ""
            grep -B3 -A5 "Error" maven-output.log | head -20
            exit 1
          elif grep -q "Could not transfer artifact\|Connection refused\|UnknownHostException" maven-output.log; then
            echo "‚ö†Ô∏è  Network/repository issue - not a compatibility problem"
            echo "Marking as success (not a compatibility issue)"
            exit 0
          elif grep -q "no config file was found" maven-output.log; then
            echo "‚ö†Ô∏è  JFrog config issue - this was handled, checking if build succeeded despite warning"
            if grep -q "ERROR" maven-output.log | grep -v "WARN"; then
              echo "‚ùå Build has actual errors"
              tail -30 maven-output.log
              exit 1
            else
              echo "‚úÖ Only warnings, build may have succeeded"
              exit 0
            fi
          else
            echo "‚ùå Build failed for unknown compatibility reasons"
            echo "Last 50 lines of output:"
            tail -50 maven-output.log
            # Fail to be safe - investigate unknown failures
            exit 1
          fi

      - name: Upload logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-logs-maven-${{ matrix.maven-version }}-java-${{ matrix.java-version }}
          path: ${{ github.workspace }}/test-project/maven-output.log
          retention-days: 30
          if-no-files-found: ignore

  check-new-maven-fields:
    name: Check for new DefaultMavenPluginManager fields
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout build-info
        uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Download latest Maven source
        run: |
          # Get latest Maven release version
          LATEST_MAVEN=$(curl -s https://api.github.com/repos/apache/maven/releases/latest | \
            grep '"tag_name":' | sed -E 's/.*"maven-([^"]+)".*/\1/')
          echo "Latest Maven version: $LATEST_MAVEN"
          
          # Create temp directory
          TEMP_DIR=$(mktemp -d)
          cd "$TEMP_DIR"
          
          # Download Maven source
          curl -L "https://github.com/apache/maven/archive/refs/tags/maven-${LATEST_MAVEN}.tar.gz" \
            -o maven-source.tar.gz
          
          tar -xzf maven-source.tar.gz
          
          # Find DefaultMavenPluginManager
          PLUGIN_MANAGER=$(find . -name "DefaultMavenPluginManager.java" | head -1)
          
          if [ -z "$PLUGIN_MANAGER" ]; then
            echo "‚ö†Ô∏è  Could not find DefaultMavenPluginManager.java"
            exit 0
          fi
          
          echo "Found DefaultMavenPluginManager at: $PLUGIN_MANAGER"
          
          # Extract field declarations (handle both @Inject and final fields)
          echo "=== Fields in DefaultMavenPluginManager ==="
          
          # Try @Inject annotated fields first
          if grep -q "@Inject" "$PLUGIN_MANAGER"; then
            grep -B1 "@Inject" "$PLUGIN_MANAGER" | grep "private" | \
              sed -E 's/.*private .* ([a-zA-Z0-9_]+);/\1/' > /tmp/maven-fields.txt
          else
            # Fallback to private final fields (modern Maven uses constructor injection)
            grep -E "private final " "$PLUGIN_MANAGER" | \
              sed -E 's/.*private final .* ([a-zA-Z0-9_]+);/\1/' > /tmp/maven-fields.txt
          fi
          
          if [ -s /tmp/maven-fields.txt ]; then
            cat /tmp/maven-fields.txt
            FIELD_COUNT=$(wc -l < /tmp/maven-fields.txt | tr -d ' ')
            echo ""
            echo "Total: $FIELD_COUNT fields"
          else
            echo "No fields found (file may have different structure)"
            echo "Manual review recommended"
          fi
      
      - name: Compare with components.xml
        run: |
          echo "=== Fields in our components.xml ==="
          
          # Extract field names from the ArtifactoryEclipsePluginManager component
          COMPONENTS_FILE="build-info-extractor-maven3/src/main/resources/META-INF/plexus/components.xml"
          
          if [ ! -f "$COMPONENTS_FILE" ]; then
            echo "‚ö†Ô∏è  components.xml not found at $COMPONENTS_FILE"
            exit 0
          fi
          
          # Get all field-name entries
          grep -E "<field-name>.*</field-name>" "$COMPONENTS_FILE" | \
            sed 's/.*<field-name>\(.*\)<\/field-name>.*/\1/' | \
            sort | uniq > /tmp/our-fields.txt
          
          cat /tmp/our-fields.txt
          
          # Compare if we have maven fields
          if [ -f /tmp/maven-fields.txt ]; then
            echo ""
            echo "=== Comparing fields ==="
            
            MISSING=$(comm -23 /tmp/maven-fields.txt /tmp/our-fields.txt || true)
            
            if [ -n "$MISSING" ]; then
              echo "‚ö†Ô∏è  NEW FIELDS in Maven (not in our components.xml):"
              echo "$MISSING"
              echo ""
              echo "These fields should be reviewed and possibly added!"
            else
              echo "‚úÖ All Maven fields are covered"
            fi
          fi
          
          echo ""
          echo "üí° If new fields appear in Maven's DefaultMavenPluginManager,"
          echo "   they should be added to our components.xml file!"

  create-issue-on-failure:
    name: Create issue if compatibility test fails
    needs: [test-maven-compatibility]
    if: failure()
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: Create issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = 'üö® Maven Compatibility Test Failed';
            const body = `## Maven Compatibility Test Failure
            
            The automated Maven compatibility test has detected a failure with one or more Maven versions.
            
            **Details:**
            - Run: ${{ github.run_number }}
            - Workflow: ${{ github.workflow }}
            - Triggered by: ${{ github.event_name }}
            - Link: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            **Possible Causes:**
            1. A new Maven version has been released with breaking changes
            2. New required fields have been added to DefaultMavenPluginManager
            3. Method signatures have changed in Maven core classes
            4. New dependencies or requirements were introduced
            5. Our Plexus components.xml is missing field declarations
            
            **Action Required:**
            1. Check the workflow logs for specific error messages
            2. Download the failure logs artifact from the workflow run
            3. Look for error patterns:
               - \`NullPointerException\` ‚Üí Missing field in components.xml
               - \`NoSuchMethodError\` ‚Üí Method signature changed
               - \`NoClassDefFoundError\` ‚Üí Missing dependency
            4. If NullPointerException on a field:
               - Identify the missing field name from the error
               - Download Maven source for that version
               - Find new fields in \`DefaultMavenPluginManager.java\`
               - Update \`build-info-extractor-maven3/src/main/resources/META-INF/plexus/components.xml\`
               - Add missing field requirements to the ArtifactoryEclipsePluginManager component
            
            **Helpful Commands:**
            \`\`\`bash
            # Check for missing fields in a specific Maven version
            ./CHECK-MAVEN-FIELDS.sh <maven-version>
            
            # Compare Maven's DefaultMavenPluginManager with our components.xml
            # Look for new fields that need to be added
            \`\`\`
            
            **Resources:**
            - Maven release notes: https://maven.apache.org/docs/history.html
            - Our components.xml: \`build-info-extractor-maven3/src/main/resources/META-INF/plexus/components.xml\`
            - DefaultMavenPluginManager source: Search in Maven's GitHub repository
            `;
            
            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'maven-compatibility'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['bug', 'maven-compatibility', 'automated']
              });
            } else {
              console.log('Issue already exists, adding comment instead');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `Another failure detected in run #${{ github.run_number }}\n\nLink: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`
              });
            }
